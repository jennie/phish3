<template>
  <div class="start-screen h-screen flex flex-col justify-center items-center bg-red-600 text-gray-100">

    <svg width="276px" height="118px" viewBox="0 0 276 118" version="1.1" xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink">
      <title>game-title</title>
      <g id="UX-Flow" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Artboard" transform="translate(-337, -605)" fill="#FFFFFF">
          <g id="card-back" transform="translate(313, 421)">
            <g id="game-title" transform="translate(24, 184)">
              <text id="Security-Awareness-O" font-family="MinionPro-Capt, Minion Pro" font-size="20"
                font-weight="normal">
                <tspan x="0.6" y="112">Security Awareness Online Game</tspan>
              </text>
              <g id="Senecea_Polytechnic" transform="translate(28, 0)" fill-rule="nonzero">
                <g id="Polytechnic" transform="translate(0, 61)">
                  <path
                    d="M0,0.38121547 L8.56947039,0.38121547 C13.7382804,0.38121547 17.1389408,3.04972376 17.1389408,7.43605484 L17.1389408,7.50194393 C17.1389408,12.2977287 13.0164878,14.7779824 8.14802103,14.7779824 L2.58198288,14.7779824 L2.58198288,22.6234909 L0,22.6234909 L0,0.385921833 L0,0.38121547 Z M8.24006169,12.4859832 C12.033106,12.4859832 14.5182039,10.5140168 14.5182039,7.59136485 L14.5182039,7.53018212 C14.5182039,4.35338654 12.0670157,2.70145283 8.37085632,2.70145283 L2.58198288,2.70145283 L2.58198288,12.4859832 L8.24006169,12.4859832 Z"
                    id="Shape"></path>
                  <path
                    d="M19.5174654,11.5682423 L19.5174654,11.5023532 C19.5174654,5.36996112 24.2599818,0 31.2260069,0 C38.192032,0 42.8667289,5.30407203 42.8667289,11.4364641 L42.8667289,11.4976468 C42.8667289,17.6300389 38.1242125,23 31.1581874,23 C24.1921623,23 19.5174654,17.695928 19.5174654,11.5635359 L19.5174654,11.5682423 Z M40.1878611,11.5682423 L40.1878611,11.5023532 C40.1878611,6.4524248 36.3948169,2.32023736 31.1630317,2.32023736 C25.9312465,2.32023736 22.2011774,6.38653571 22.2011774,11.4364641 L22.2011774,11.4976468 C22.2011774,16.5475752 25.9942217,20.6797626 31.2260069,20.6797626 C36.4577921,20.6797626 40.1878611,16.6134643 40.1878611,11.5635359 L40.1878611,11.5682423 Z"
                    id="Shape"></path>
                  <polygon id="Path"
                    points="47.0182474 0.38121547 49.6002303 0.38121547 49.6002303 20.3032535 62.4859234 20.3032535 62.4859234 22.6234909 47.0182474 22.6234909 47.0182474 0.385921833">
                  </polygon>
                  <polygon id="Path"
                    points="68.8609506 13.8225905 59.3468523 0.385921833 62.4859234 0.385921833 70.2028066 11.5070595 77.9875092 0.385921833 80.9957857 0.385921833 71.4816874 13.7943524 71.4816874 22.6281973 68.8657948 22.6281973 68.8657948 13.8272969">
                  </polygon>
                  <polygon id="Path"
                    points="89.8510666 2.70145283 82.1680931 2.70145283 82.1680931 0.38121547 100.154777 0.38121547 100.154777 2.70145283 92.4718034 2.70145283 92.4718034 22.6234909 89.8559108 22.6234909 89.8559108 2.70145283">
                  </polygon>
                  <polygon id="Path"
                    points="103.681388 0.38121547 120.22933 0.38121547 120.22933 2.66850829 106.263371 2.66850829 106.263371 10.2598731 118.75668 10.2598731 118.75668 12.547166 106.263371 12.547166 106.263371 20.3314917 120.389191 20.3314917 120.389191 22.6187845 103.676543 22.6187845 103.676543 0.38121547">
                  </polygon>
                  <path
                    d="M123.266672,11.5682423 L123.266672,11.5023532 C123.266672,5.20994475 128.106074,0 134.844419,0 C138.995938,0 141.481036,1.4307346 143.772364,3.5250665 L142.004214,5.36996112 C140.076205,3.5909556 137.915671,2.32023736 134.81051,2.32023736 C129.743429,2.32023736 125.950384,6.32535298 125.950384,11.4364641 L125.950384,11.4976468 C125.950384,16.6464088 129.777338,20.6797626 134.81051,20.6797626 C137.949581,20.6797626 140.008385,19.5031717 142.202828,17.4700225 L143.903159,19.0890117 C141.514945,21.4421936 138.899053,22.9952936 134.747534,22.9952936 C128.139983,22.9952936 123.271517,17.9453653 123.271517,11.5588295 L123.266672,11.5682423 Z"
                    id="Path"></path>
                  <polygon id="Path"
                    points="147.105205 0.38121547 149.687188 0.38121547 149.687188 10.2598731 162.897445 10.2598731 162.897445 0.38121547 165.479428 0.38121547 165.479428 22.6187845 162.897445 22.6187845 162.897445 12.613055 149.687188 12.613055 149.687188 22.6187845 147.105205 22.6187845 147.105205 0.38121547">
                  </polygon>
                  <polygon id="Path"
                    points="170.648238 0.38121547 173.070361 0.38121547 187.49168 18.2042153 187.49168 0.38121547 190.010688 0.38121547 190.010688 22.6187845 187.951883 22.6187845 173.17209 4.38162472 173.17209 22.6187845 170.653083 22.6187845 170.653083 0.38121547">
                  </polygon>
                  <polygon id="Path"
                    points="195.397489 0.38121547 197.979472 0.38121547 197.979472 22.6187845 195.397489 22.6187845">
                  </polygon>
                  <path
                    d="M202.363514,11.5682423 L202.363514,11.5023532 C202.363514,5.20994475 207.202915,0 213.941261,0 C218.092779,0 220.577877,1.4307346 222.869205,3.5250665 L221.101056,5.36996112 C219.173046,3.5909556 217.012512,2.32023736 213.907351,2.32023736 C208.84027,2.32023736 205.047226,6.32535298 205.047226,11.4364641 L205.047226,11.4976468 C205.047226,16.6464088 208.87418,20.6797626 213.907351,20.6797626 C217.046422,20.6797626 219.105227,19.5031717 221.29967,17.4700225 L223,19.0890117 C220.611787,21.4421936 217.995894,22.9952936 213.844376,22.9952936 C207.236825,22.9952936 202.368358,17.9453653 202.368358,11.5588295 L202.363514,11.5682423 Z"
                    id="Path"></path>
                </g>
                <g id="Seneca">
                  <path
                    d="M15.0033652,41.5204152 C19.4484466,41.5204152 22.15732,39.2387543 22.15732,36.3273356 C22.15732,31.899654 17.2939925,30.6546713 10.6993204,27.2636678 C4.16787164,23.9404844 0.763542413,19.1688581 0.763542413,13.6318339 C0.763542413,5.67750865 7.21717797,0 18.0575349,0 C22.08437,0 25.8388589,0.760553633 29.865694,2.21384083 L29.865694,10.100346 C25.9069454,8.09480969 22.706876,6.92249135 20.0709525,6.92249135 C16.3164637,6.92249135 13.8896633,8.99584775 13.8896633,11.4906574 C13.8896633,15.36609 18.8940272,16.7515571 27.0157841,21.1792388 C32.4335309,24.1536332 34.9381446,28.2373702 34.9381446,33.9100346 C34.9381446,42.6975779 27.6431533,48.7916955 16.3942769,48.7916955 C11.7400725,48.7916955 7.21717797,47.8906574 2.42680041,46.2968858 L0,36.3273356 C5.48583339,39.650519 10.1351745,41.5204152 15.0033652,41.5204152"
                    id="Path"></path>
                  <path
                    d="M50.7585488,31.2069204 C50.7585488,31.6283737 50.6904622,32.0546713 50.6904622,32.4083045 C50.6904622,38.4733564 54.6589374,42.0096886 61.1077097,42.0096886 C64.2980525,42.0096886 68.1303545,40.6726644 72.9450487,38.4103806 L70.3966651,46.5972318 C66.2142035,48.0117647 62.2457283,49 57.7763304,49 C45.087909,49 37.647018,41.8692042 37.647018,31.2747405 C37.647018,20.6802768 45.4477952,13.1958478 56.0790291,13.1958478 C65.509021,13.1958478 72.5219393,19.832526 72.5219393,30.2865052 L72.5219393,31.2020761 L50.7585488,31.2020761 L50.7585488,31.2069204 Z M55.7240062,19.7647059 C52.9567728,19.7647059 51.1865216,21.600692 51.0406218,24.9916955 L60.1155909,24.9916955 C60.1155909,21.532872 58.5544628,19.7647059 55.7240062,19.7647059"
                    id="Shape"></path>
                  <path
                    d="M76.9232506,41.7238754 L76.9232506,20.8256055 C76.9232506,18.0692042 76.3542413,16.1653979 74.5110402,14.4698962 L77.7743329,14.4698962 C81.4607351,14.4698962 85.215224,14.3342561 89.1156126,13.6948097 L89.3976856,17.1584775 C92.2330055,14.8961938 94.9272889,13.767474 98.1176317,13.767474 C105.563386,13.767474 110.382944,18.500346 110.382944,26.1979239 L110.382944,41.733564 C110.382944,44.4851211 110.951953,46.3211073 112.795154,48.016609 L95.5011616,48.016609 C97.3443627,46.3211073 97.9085087,44.4851211 97.9085087,41.733564 L97.9085087,30.9307958 C97.9085087,24.3619377 97.0574263,20.9031142 93.4391107,20.9031142 C89.8207951,20.9031142 89.3976856,24.3619377 89.3976856,30.9307958 L89.3976856,41.733564 C89.3976856,44.4851211 89.9666949,46.3211073 91.8050327,48.016609 L74.5110402,48.016609 C76.3542413,46.3211073 76.9232506,44.4851211 76.9232506,41.733564"
                    id="Path"></path>
                  <path
                    d="M127.351093,31.2069204 C127.351093,31.6283737 127.283007,32.0546713 127.283007,32.4083045 C127.283007,38.4733564 131.251482,42.0096886 137.700254,42.0096886 C140.890597,42.0096886 144.722899,40.6726644 149.537593,38.4103806 L146.989209,46.5972318 C142.801885,48.0117647 138.833409,49 134.368875,49 C121.680453,49 114.239562,41.8692042 114.239562,31.2747405 C114.239562,20.6802768 122.04034,13.1958478 132.671573,13.1958478 C142.101565,13.1958478 149.114484,19.832526 149.114484,30.2865052 L149.114484,31.2020761 L127.351093,31.2020761 L127.351093,31.2069204 Z M132.316551,19.7647059 C129.549317,19.7647059 127.779066,21.600692 127.633166,24.9916955 L136.708135,24.9916955 C136.708135,21.532872 135.15187,19.7647059 132.316551,19.7647059"
                    id="Shape"></path>
                  <path
                    d="M183.269632,46.6698962 C179.58323,48.2927336 175.964915,49 172.137476,49 C160.295273,49 152.781433,41.5155709 152.781433,31.5605536 C152.781433,21.0387543 160.791333,13.2733564 173.343581,13.2733564 C175.327819,13.2733564 177.949152,13.5543253 181.285395,14.0484429 L181.285395,22.4532872 C178.445212,20.9709343 176.183764,20.1910035 174.340563,20.1910035 C169.662042,20.1910035 166.612736,23.7224913 166.612736,29.8698962 C166.612736,37.1411765 170.231051,41.5882353 176.183764,41.5882353 C179.019084,41.5882353 182.136477,40.6 185.822879,38.6186851 L183.274496,46.6698962 L183.269632,46.6698962 Z"
                    id="Path"></path>
                  <path
                    d="M199.12408,38.0519031 C199.12408,40.5273356 200.894331,42.2228374 204.016587,42.2228374 L204.580733,42.2228374 L201.604377,48.5058824 C199.615276,48.6463668 198.268134,48.7190311 197.417052,48.7190311 C190.399271,48.7190311 185.652663,44.199308 185.652663,38.1972318 C185.652663,32.9750865 188.984042,29.6567474 195.505764,28.1017301 C201.74055,26.6193772 205.786839,26.7598616 205.786839,23.3737024 C205.786839,21.2519031 204.29866,20.1231834 201.317441,20.1231834 C198.336221,20.1231834 195.505764,20.8256055 192.315422,22.099654 L195.641938,14.5425606 C198.341084,13.767474 200.889468,13.2733564 203.583751,13.2733564 C209.113355,13.2733564 213.08183,14.4020761 215.635077,17.0179931 C218.611433,20.0553633 218.684383,23.8678201 218.684383,28.7363322 L218.684383,37.2089965 C218.684383,40.8809689 219.958575,41.9418685 224,42.5086505 L221.31058,48.4380623 C219.467379,48.5785467 218.193187,48.6512111 217.342105,48.6512111 C210.53831,48.6512111 205.713889,44.4802768 205.713889,38.1972318 L205.713889,32.2678201 C201.317441,33.9584775 199.119217,35.232526 199.119217,38.0567474"
                    id="Path"></path>
                </g>
              </g>
            </g>
          </g>
        </g>
      </g>
    </svg>

    <div v-if="isLoading" class="loading-container w-full max-w-md px-4 text-center">
      <p class="text-2xl mb-4">Loading...</p>
      <div class="flex justify-center items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-white"></div>
      </div>
    </div>

    <div v-else class="start-game w-full max-w-md px-4">
      <AuthState v-slot="{ loggedIn, user, clear }">
        <div v-if="loggedIn" class="text-center">
          <button v-if="canDownloadCsv" @click="downloadCsv"
            class=" text-white uppercase mt-4 underline text-lg font-semibold  mb-4">
            Download Scores
          </button>
          <p class="text-xl mb-2">Welcome, {{ user.email }}!</p>

          <p class="mb-4" v-if="user.bestScore > 0">Your best score: {{ bestScorePercentage }}%</p>

          <button @click="startGame"
            class="bg-gray-200 text-zinc-800 rounded-full px-12 py-3 text-lg font-semibold hover:bg-gray-300 transition-colors mb-4">
            Start Game
          </button>
          <button @click="logout"
            class="block text-center mx-auto uppercase text-gray-300 underline text-sm font-semibold transition-colors mb-2">
            Logout
          </button>
        </div>
        <div v-else>
          <h2 class="text-2xl mb-2 text-center font-display mt-12">Enter Your Seneca Email to Play</h2>
          <p class="text-sm mb-4 text-center">New to the game? We'll create an account for you!</p>
          <form @submit.prevent="requestLogin" class="flex flex-col items-center">
            <input v-model="email" type="email" placeholder="Your Seneca Email" required
              class="w-full px-4 py-2 mb-4 text-black rounded-full focus:outline-red-500">
            <button type="submit"
              class="bg-white text-zinc-800 rounded-full px-6 py-3 text-lg font-semibold hover:bg-gray-200 transition-colors">
              Send Login Link
            </button>
          </form>
        </div>
      </AuthState>
    </div>

    <div v-if="loginMessage" class="mt-4 text-center text-white">
      {{ loginMessage }}
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useGameState } from '@/composables/gameState';
import { useUserSession } from '#imports';

const { initializeGame, gameStarted, loadingProgress } = useGameState();
const { clear, fetch: fetchSession } = useUserSession();
const isLoading = ref(true);
const email = ref('');
const loginMessage = ref('');

const startGame = () => {
  gameStarted.value = true;
};

const requestLogin = async () => {
  try {
    await $fetch('/api/auth/login-request', {
      method: 'POST',
      body: { email: email.value }
    });
    loginMessage.value = 'Login link sent to your email. If this is your first time, we\'ve created an account for you. Please check your inbox.';
    email.value = '';
  } catch (error) {
    console.error('Login request failed:', error);
    loginMessage.value = 'Failed to send login link. Please try again.';
  }
};

const logout = async () => {
  try {
    await $fetch('/api/auth/logout', { method: 'POST' });
    await clear();
    loginMessage.value = 'Logged out successfully.';
  } catch (error) {
    console.error('Logout failed:', error);
  }
};

const downloadCsv = async () => {
  try {
    const { data, error } = await useFetch('/api/admin/download-scores', {
      responseType: 'blob',
    });

    // Access the value of the refs
    if (error.value) {
      console.error('Error downloading CSV:', error.value);
      return;
    }

    // Create a blob from the data and generate a download link
    const csvBlob = new Blob([data.value], { type: 'text/csv' });
    const url = window.URL.createObjectURL(csvBlob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'users.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch (error) {
    console.error('Error:', error);
  }
};

// Check if the user can download the CSV
const canDownloadCsv = computed(() => {
  const user = useUserSession().user;
  return user.value.type === 'gammaspace' || user.value.type === 'employee';
});

// Load scenarios on mount and handle loading state
onMounted(async () => {
  await initializeGame();
  await fetchSession();
  setTimeout(() => {
    isLoading.value = false;
  }, 500); // A small delay to ensure smoother transition after loading
});

// Computed property for bestScore percentage
const bestScorePercentage = computed(() => {
  const user = useUserSession().user;
  return user.value.bestScore > 0 ? (user.value.bestScore / 5) * 100 : 0;
});
</script>
